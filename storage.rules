rules_version = '2';

service firebase.storage {
  // Helper function to validate if user is a participant of the job
  function isJobParticipant(jobId) {
    let job = firestore.get(/databases/(default)/documents/jobs/$(jobId)).data;
    return request.auth != null 
        && (request.auth.uid == job.clientId 
         || request.auth.uid == job.providerId);
  }

  match /b/{bucket}/o {
    // Only job participants (client or provider) can upload files
    // Read is still open to authenticated users for viewing attachments
    match /jobs/{jobId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if isJobParticipant(jobId);
    }
  }
}