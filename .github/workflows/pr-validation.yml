name: PR Validation + Guardrails

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    name: 'ValidaÃ§Ã£o + Guardrails de SegregaÃ§Ã£o'

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependÃªncias
        run: npm ci

      - name: Lint
        run: npm run lint:ci
        continue-on-error: true

      - name: TypeCheck
        run: npm run typecheck

      - name: Testes unitÃ¡rios
        run: npm test -- --run
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}

      - name: Testes backend
        run: npm run test:backend
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Build de produÃ§Ã£o
        run: npm run build

      - name: ðŸ›¡ï¸ GUARDRAIL - SegregaÃ§Ã£o Executor/GEMINI
        run: |
          echo "ðŸ›¡ï¸  Executando guardrail anti-simulaÃ§Ã£o..."
          npm run guardrail:check
        shell: bash

      - name: Smoke tests E2E
        run: npm run e2e:smoke
        continue-on-error: true

      - name: RelatÃ³rio de validaÃ§Ã£o
        if: always()
        run: |
          echo "## âœ… ValidaÃ§Ã£o Completa" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lint executado" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TypeCheck passou" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Testes unitÃ¡rios executados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build de produÃ§Ã£o OK" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Guardrail de segregaÃ§Ã£o PASSOU" >> $GITHUB_STEP_SUMMARY
