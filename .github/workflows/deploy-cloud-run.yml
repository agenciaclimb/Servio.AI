name: Deploy to Cloud Run

on:
  # Torna o deploy explícito e previsível: execute manualmente
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch ou tag para deploy'
        required: false
        default: 'feature/full-implementation'
      service:
        description: 'Serviço para deploy (ai, backend, ou both)'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - ai
          - backend
  # (Opcional) Publique versões marcadas com tag v*
  push:
    tags:
      - 'v*'

env:
  # ✅ CORRIGIDO: Projeto correto (ID: 1000250760228)
  PROJECT_ID: gen-lang-client-0737507616
  REGION: us-west1
  # SERVICE secret não é mais obrigatório; serviços são definidos por step
  REPO: servio-ai

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Evita execuções concorrentes que causam erros de IAM/Cloud Build
    concurrency:
      group: deploy-${{ github.ref_name }}
      cancel-in-progress: true

    steps:
      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Validate required secrets and inputs
        shell: bash
        env:
          GH_GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GH_GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          GH_GCP_STORAGE_BUCKET: ${{ secrets.GCP_STORAGE_BUCKET }}
          GH_STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          GH_STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          missing=()
          # Infra
          [[ -z "${PROJECT_ID:-}" ]] && missing+=("GCP_PROJECT_ID")
          [[ -z "${REGION:-}" ]] && missing+=("GCP_REGION")
          [[ -z "${GH_GCP_SA_KEY:-}" ]] && missing+=("GCP_SA_KEY")
          # App (não bloqueia o deploy, mas avisamos)
          app_missing=()
          [[ -z "${GH_GEMINI_API_KEY:-}" ]] && app_missing+=("GEMINI_API_KEY")
          [[ -z "${GH_FRONTEND_URL:-}" ]] && app_missing+=("FRONTEND_URL")
          [[ -z "${GH_GCP_STORAGE_BUCKET:-}" ]] && app_missing+=("GCP_STORAGE_BUCKET")
          [[ -z "${GH_STRIPE_SECRET_KEY:-}" ]] && app_missing+=("STRIPE_SECRET_KEY")
          [[ -z "${GH_STRIPE_WEBHOOK_SECRET:-}" ]] && app_missing+=("STRIPE_WEBHOOK_SECRET")

          if (( ${#missing[@]} > 0 )); then
            echo "::error::Secrets obrigatórios ausentes: ${missing[*]}"
            echo "Adicione-os em Settings → Secrets and variables → Actions. Consulte GITHUB_SECRETS.md."
            exit 1
          fi
          if (( ${#app_missing[@]} > 0 )); then
            echo "::warning::Secrets de aplicação ausentes (o deploy continuará): ${app_missing[*]}"
          fi

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@71f986410dfbc7added4569d411d040a91dc6935 # v2.1.8
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # Para futura migração a Workload Identity Federation (mais seguro):
          # workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          # service_account: ${{ secrets.GCP_DEPLOY_SA }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200 # v2.1.0
        with:
          version: '>= 462.0.0'

      - name: Activate service account in gcloud (explicit)
        run: |
          set -x
          KEY_FILE="${GOOGLE_APPLICATION_CREDENTIALS:-${GOOGLE_GHA_CREDS_PATH:-}}"
          if [ -n "$KEY_FILE" ] && [ -f "$KEY_FILE" ]; then
            gcloud auth activate-service-account --key-file="$KEY_FILE"
            echo "Service Account (from key file):" && cat "$KEY_FILE" | jq -r '.client_email'
          else
            echo "::warning::Service account key file environment variable not set; relying on auth action overrides"
          fi

      - name: Configure gcloud project and verify APIs
        run: |
          set -x
          gcloud config set project "$PROJECT_ID"
          gcloud services list --enabled --project "$PROJECT_ID" | grep -E "(run.googleapis.com|cloudbuild.googleapis.com|artifactregistry.googleapis.com)" || true

      - name: GCloud info (preflight)
        run: |
          set -x
          gcloud --version
          gcloud auth list
          gcloud config list
          echo "Project: $PROJECT_ID / Region: $REGION"
          echo "Serviços alvo: servio-ai (AI) e servio-backend (REST API)"
          echo "Verificando APIs necessárias..."
          gcloud services list --enabled --project "$PROJECT_ID" | grep -E "(run.googleapis.com|cloudbuild.googleapis.com|artifactregistry.googleapis.com)" || true

      - name: Artifact Registry diagnostics
        run: |
          set -x
          echo "Descrevendo repositório Artifact Registry..."
          gcloud artifacts repositories describe "$REPO" --location="$REGION" || true
          echo "Listando repositórios na região..."
          gcloud artifacts repositories list --location="$REGION" || true
          echo "Política de IAM do repositório (completa):"
          gcloud artifacts repositories get-iam-policy "$REPO" --location="$REGION" --format=json || true
          echo "Conta gcloud ativa:"
          gcloud auth list --filter=status:ACTIVE --format="value(account)" || true
          echo "Listando imagens existentes (se houver) para confirmar acesso de leitura..."
          gcloud artifacts docker images list "$REGION-docker.pkg.dev/$PROJECT_ID/$REPO" || true

      # ===== Build & Deploy without Cloud Build (avoids _cloudbuild bucket permission) =====
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Configure Docker to use gcloud as credential helper
        run: |
          set -x
          # Configure docker to use gcloud credentials directly
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet
          # Verify authentication works
          gcloud auth application-default print-access-token

      - name: Docker login (explicit) to Artifact Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      - name: Show Docker config for registry host
        run: |
          set -x
          if [ -f "$HOME/.docker/config.json" ]; then
            echo "~/.docker/config.json:" && cat "$HOME/.docker/config.json" | sed -E 's/"auth"\s*:\s*"[^"]+"/"auth":"***"/g'
          else
            echo "Docker config.json não encontrado"
          fi

      - name: Check AI Dockerfile exists
        id: ai_check
        run: |
          if [ -f "./Dockerfile" ]; then
            echo "has_ai=true" >> $GITHUB_OUTPUT
          else
            echo "has_ai=false" >> $GITHUB_OUTPUT
          fi

      - name: Sanity push to Artifact Registry (hello-world)
        run: |
          set -euo pipefail
          docker pull hello-world:latest
          docker tag hello-world:latest "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/sanity:gha-${GITHUB_RUN_ID}"
          docker push "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/sanity:gha-${GITHUB_RUN_ID}"

      # Repository 'servio-ai' already exists in us-west1
      # No need to create it on every run

      - name: Build & Push AI image (Docker)
        if: ${{ (github.event.inputs.service == 'both' || github.event.inputs.service == 'ai' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name, '-backend'))) && steps.ai_check.outputs.has_ai == 'true' }}
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ./Dockerfile
          push: true
          provenance: false
          sbom: false
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO }}/ai-server:${{ github.sha }}
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO }}/ai-server:latest

      - name: Deploy AI Service
        if: ${{ (github.event.inputs.service == 'both' || github.event.inputs.service == 'ai' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name, '-backend'))) && steps.ai_check.outputs.has_ai == 'true' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        run: |
          set -euo pipefail
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/ai-server:${GITHUB_SHA}"
          gcloud run deploy servio-ai \
            --image="$IMAGE" \
            --region="$REGION" \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="GEMINI_API_KEY=${GEMINI_API_KEY},FRONTEND_URL=${FRONTEND_URL}"

      - name: Build & Push Backend image (Docker)
        if: ${{ github.event.inputs.service == 'both' || github.event.inputs.service == 'backend' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) }}
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          provenance: false
          sbom: false
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO }}/backend:${{ github.sha }}
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO }}/backend:latest

      - name: Deploy Backend Service
        if: ${{ github.event.inputs.service == 'both' || github.event.inputs.service == 'backend' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) }}
        run: |
          set -euo pipefail
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/backend:${GITHUB_SHA}"
          gcloud run deploy servio-backend \
            --image="$IMAGE" \
            --region="$REGION" \
            --platform=managed \
            --allow-unauthenticated \
            --port=8081 \
            --set-env-vars="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }},STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }},FRONTEND_URL=${{ secrets.FRONTEND_URL }},GCP_STORAGE_BUCKET=${{ secrets.GCP_STORAGE_BUCKET }}"
