rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================
    // Helper Functions
    // =================================
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Email-based helpers (documents keyed by email instead of auth.uid)
    function authEmail() {
      return isSignedIn() ? request.auth.token.email : null;
    }
    
    function isOwnerEmail(docId) {
      return isSignedIn() && authEmail() == docId;
    }
    
    // USER DATA: Documentos users usam EMAIL como ID, não UID
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    function getUserByEmail() {
      return get(/databases/$(database)/documents/users/$(authEmail())).data;
    }

    function isAdmin() {
      return isSignedIn() && getUserByEmail().type == 'admin';
    }
    
    function isClient() {
      return isSignedIn() && getUserByEmail().type == 'cliente';
    }

    function isProvider() {
      return isSignedIn() && getUserByEmail().type == 'prestador';
    }
    
    // JOBS: clientId e providerId armazenam EMAIL, não UID
    function isJobParticipant(jobId) {
      let job = get(/databases/$(database)/documents/jobs/$(jobId)).data;
      return isSignedIn() && (authEmail() == job.clientId || authEmail() == job.providerId);
    }

    // =================================
    // Collection Rules
    // =================================

    match /users/{userId} {
      // Only own profile or admin can read (PREVENT PII EXPOSURE)
      allow read: if isOwnerEmail(userId) || isAdmin();
      
      // User can create their own document (userId = email) with required fields
      allow create: if isOwnerEmail(userId)
                    && request.resource.data.email == userId
                    && request.resource.data.type in ['cliente', 'prestador', 'prospector', 'admin']
                    && request.resource.data.name is string
                    && request.resource.data.email is string;

      // User can update their own profile (email-based). Admin can update any profile.
      // Prevent privilege escalation: regular users cannot change their type
      allow update: if (isOwnerEmail(userId) && request.resource.data.type == resource.data.type)
                    || isAdmin();
      
      // Deletion is disallowed for now.
      allow delete: if false;
    }

    match /jobs/{jobId} {
      // Only job participants or admin can read job details (PREVENT DATA EXPOSURE)
      allow read: if isJobParticipant(jobId) || isAdmin();
      
      // Client can create job (clientId = email, must match auth)
      allow create: if isClient() 
                    && isOwnerEmail(request.resource.data.clientId)
                    && request.resource.data.title is string
                    && request.resource.data.description is string
                    && request.resource.data.category is string;
      
      // Only a job participant or an admin can update a job (PREVENT UNAUTHORIZED UPDATES)
      // Regular participants can only update certain fields (not status/payments without admin)
      allow update: if (isJobParticipant(jobId) && !('status' in request.resource.data.diff.changedKeys()))
                    || isAdmin();
      
      allow delete: if false;
    }

    match /proposals/{proposalId} {
      // Only job participants can read proposals for that job (PREVENT INFORMATION LEAK)
      allow read: if isJobParticipant(resource.data.jobId);
      
      // Provider can create proposal with valid required fields
      allow create: if isProvider() 
                    && getUserByEmail().verificationStatus == 'verificado'
                    && isOwnerEmail(request.resource.data.providerId)
                    && isJobParticipant(request.resource.data.jobId)
                    && request.resource.data.amount is number
                    && request.resource.data.amount > 0
                    && request.resource.data.jobId is string;
                    
      // Client can update proposal to accept/reject it (must own the job)
      allow update: if get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.clientId == authEmail()
                    && (request.resource.data.status in ['accepted', 'rejected']);
      
      allow delete: if false;
    }

    match /messages/{messageId} {
      // Only participants of the chat (job) can read or create messages
      allow read: if isJobParticipant(resource.data.chatId);
      // Sender must be a job participant and must set their email as sender
      allow create: if isJobParticipant(request.resource.data.chatId)
                    && isOwnerEmail(request.resource.data.sender)
                    && request.resource.data.text is string
                    && request.resource.data.createdAt is timestamp;
      allow update, delete: if false;
    }

    match /notifications/{notificationId} {
      // Recipient can read/update notifications (userId = email)
      allow read, update: if isOwnerEmail(resource.data.userId);
      // Only the system (backend) can create notifications, so client writes are disallowed
      allow create, delete: if false;
    }

    match /escrows/{escrowId} {
      // Only participants or admins can read escrow details
      allow read: if isJobParticipant(resource.data.jobId) || isAdmin();
      // Only the system (backend) can create or update escrows
      allow create, update, delete: if false;
    }

    match /fraud_alerts/{alertId} {
      // Only admins can read/update fraud alerts
      allow read, update: if isAdmin();
      // Only the system (backend) can create alerts
      allow create, delete: if false;
    }

    match /disputes/{disputeId} {
      // Only the initiator, the other job participant, or an admin can read
      allow read: if isJobParticipant(resource.data.jobId) || isAdmin();
      // A job participant can create a dispute
      allow create: if isJobParticipant(request.resource.data.jobId);
      // Only an admin can resolve (update) a dispute
      allow update: if isAdmin();
      allow delete: if false;
    }

    match /maintained_items/{itemId} {
      // Owner can manage items (clientId = email)
      allow read, create, update, delete: if isOwnerEmail(resource.data.clientId);
    }

    match /bids/{bidId} {
      // Similar to proposals - only job participants can read
      allow read: if isJobParticipant(resource.data.jobId);
      // Provider can create bid with valid data
      allow create: if isProvider() 
                    && isOwnerEmail(request.resource.data.providerId)
                    && isJobParticipant(request.resource.data.jobId)
                    && request.resource.data.amount is number
                    && request.resource.data.amount > 0;
      allow update, delete: if false;
    }

    // =================================
    // Prospecting Module Rules
    // =================================
    
    function isProspector() {
      return isSignedIn() && getUserByEmail().type == 'prospector';
    }
    
    function isProspectorByEmail() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(authEmail())).data.type == 'prospector';
    }

    match /referral_links/{prospectorId} {
      // Prospector can read/write their own referral link (email-based id) or if identified via UID
      // Prevent other users from accessing
      allow read, create, update: if isOwnerEmail(prospectorId) || isOwner(prospectorId) || isAdmin();
      allow delete: if false;
    }

    match /link_clicks/{clickId} {
      // Prospector can read their own link clicks (supports both uid and email stored as prospectorId)
      allow read: if isSignedIn() && (resource.data.prospectorId == request.auth.uid || resource.data.prospectorId == authEmail());
      // Admin can read all clicks
      allow read: if isAdmin();
      // Client click tracking: only backend/server can write via authenticated request with special validation
      // Frontend analytics cannot write directly - must go through backend endpoint
      allow create: if false;
      allow update, delete: if false;
    }

    match /link_analytics/{prospectorId} {
      // Only the prospector owner or admin can read their analytics (prevent snooping)
      allow read: if isOwnerEmail(prospectorId) || isOwner(prospectorId) || isAdmin();
      // System (admin/backend) can write analytics
      allow write: if isAdmin();
    }

    match /message_templates/{templateId} {
      // All signed-in users can read templates
      allow read: if isSignedIn();
      // Only admin can create/update templates
      allow create, update: if isAdmin();
      allow delete: if false;
    }

    match /notification_settings/{userId} {
      // User can read/write their own notification settings
      allow read, write: if isOwner(userId);
    }

    match /prospector_stats/{prospectorId} {
      // Only prospector themselves or admin can read their stats (prevent disclosure)
      allow read: if isOwnerEmail(prospectorId) || isOwner(prospectorId) || isAdmin();
      // System updates stats (admin/backend only)
      allow write: if isAdmin();
    }

    match /prospector_leaderboard/{entryId} {
      // Anyone signed in can read leaderboard
      allow read: if isSignedIn();
      // Only system can write
      allow write: if isAdmin();
    }

    match /admin_logs/{logId} {
      // Only admin can read logs
      allow read: if isAdmin();
      // Only backend/admin can create logs
      allow create, update, delete: if false;
    }
  }
}
